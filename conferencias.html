<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asistente Avanzado de Estad√≠stica para Investigaci√≥n</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- docx for DOCX export -->
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
  <!-- FileSaver (fallback for some browsers) -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --brand:#2563eb; /* azul accesible */
      --brand-600:#1d4ed8;
      --ok:#16a34a;
      --danger:#dc2626;
      --warn:#d97706;
    }
    html,body{height:100%}
    body{font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial,sans-serif;background-color:#f0f2f5}
    /* Tooltips accesibles */
    .tooltip-container{position:relative;display:inline-block;cursor:help}
    .tooltip-text{
      visibility:hidden;opacity:0;transform:translateY(4px);
      width:260px;background:#111827;color:#fff;border-radius:.5rem;padding:.5rem .75rem;
      position:absolute;z-index:20;bottom:125%;left:50%;margin-left:-130px;transition:.2s;
      font-size:.8rem;line-height:1.2
    }
    .tooltip-container:focus .tooltip-text,
    .tooltip-container:hover .tooltip-text{visibility:visible;opacity:1;transform:translateY(0)}
    /* Animaciones suaves */
    .fade-in{animation:fadeIn .35s ease-out both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    /* Modal */
    .modal-overlay{transition:opacity .2s ease}
    .modal-content{transition:transform .2s ease}
    /* Print */
    @media print{
      body *{visibility:hidden}
      #result-section, #result-section *{visibility:visible}
      #result-section{position:absolute;left:0;top:0;width:100%;padding:1rem}
      .no-print{display:none !important}
    }
    /* Dark mode helpers */
    .dark .card{background:#0f172a;color:#e5e7eb;border-color:#1f2937}
    .dark .muted{color:#94a3b8}
    .dark body{background:#0b1220}
  </style>
</head>

<body class="min-h-screen bg-gray-50 text-gray-900 dark:bg-slate-900 dark:text-slate-100">
  <!-- Skip link -->
  <a href="#app-container" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-white dark:bg-slate-800 text-black dark:text-white px-3 py-2 rounded-md shadow">Ir al contenido</a>

  <!-- Header -->
  <header class="no-print sticky top-0 z-40 backdrop-blur bg-white/85 dark:bg-slate-900/85 border-b border-gray-200 dark:border-slate-700">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-[var(--brand)] text-white font-bold">A</span>
        <div>
          <h1 class="text-lg sm:text-xl font-semibold leading-tight">Asistente de Estad√≠stica</h1>
          <p class="text-xs sm:text-sm text-gray-500 dark:text-slate-400 leading-tight">Gu√≠a paso a paso ¬∑ compatible con impresi√≥n y exportaci√≥n</p>
        </div>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <!-- Estado guardado -->
        <div id="save-indicator" class="hidden text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">guardado</div>
        <!-- Tema -->
        <button id="theme-toggle" type="button" class="px-3 py-2 rounded-md border border-gray-200 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-800 text-sm" aria-pressed="false" title="Cambiar tema (Alt+T)">
          üåô/‚òÄÔ∏è
        </button>
        <!-- Ayuda -->
        <button id="help-button" class="px-3 py-2 rounded-md bg-[var(--brand)] hover:bg-[var(--brand-600)] text-white text-sm" title="Ayuda (Alt+H)">
          Ayuda
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6 flex gap-6">
    <!-- Aside: stepper -->
    <aside class="no-print hidden lg:block w-72">
      <div class="card bg-white border border-gray-200 rounded-xl p-4 sticky top-20">
        <h2 class="font-semibold text-gray-800 dark:text-slate-100 mb-2">Progreso</h2>
        <div class="w-full bg-gray-200 dark:bg-slate-800 rounded-full h-2 mb-4">
          <div id="progress-bar" class="bg-[var(--brand)] h-2 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
        <ol id="stepper" class="space-y-2 text-sm" aria-live="polite"></ol>
        <div class="mt-4">
          <button id="jump-last" class="w-full text-sm px-3 py-2 rounded-md border border-gray-200 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-800">Ir al √∫ltimo paso</button>
        </div>
        <div class="mt-4">
          <label class="inline-flex items-center gap-2 text-xs">
            <input id="compact-mode" type="checkbox" class="h-4 w-4 rounded border-gray-300 dark:border-slate-600">
            <span>Modo compacto</span>
          </label>
        </div>
        <div class="mt-4">
          <h3 class="font-medium text-gray-800 dark:text-slate-100 text-sm mb-2">Notas del proyecto</h3>
          <textarea id="user-notes" class="w-full min-h-[90px] text-sm rounded-md border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-900 p-2" placeholder="Anota decisiones, c√≥digos de variable, etc."></textarea>
        </div>
      </div>
    </aside>

    <!-- App container -->
    <section id="app-container" class="flex-1 card bg-white border border-gray-200 rounded-2xl shadow-xl p-5 sm:p-7 dark:bg-slate-900 dark:border-slate-700 transition-all duration-300">
      <!-- Inicio -->
      <section id="start-section" class="text-center fade-in">
        <h2 class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-slate-100 mb-2">Asistente de Estad√≠stica</h2>
        <p class="text-gray-600 dark:text-slate-400 mb-6">Te acompa√±o paso a paso para elegir la prueba adecuada con buenos h√°bitos de an√°lisis.</p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <button id="start-button" class="bg-[var(--brand)] hover:bg-[var(--brand-600)] text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-transform hover:scale-[1.01] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--brand)]">
            Comenzar planificaci√≥n
          </button>
          <button id="resume-link" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg border border-gray-200">
            Reanudar
          </button>
        </div>
        <p id="resume-text" class="text-sm text-gray-500 mt-4 hidden">Hay un progreso guardado listo para continuar.</p>
        <details class="text-left max-w-2xl mx-auto mt-6 open:shadow-sm">
          <summary class="cursor-pointer text-sm text-gray-700 dark:text-slate-300">Atajos de teclado</summary>
          <ul class="mt-2 text-sm text-gray-600 dark:text-slate-400 space-y-1">
            <li><kbd class="px-1 py-0.5 border rounded">Alt</kbd> + <kbd class="px-1 py-0.5 border rounded">‚Üí</kbd> Siguiente</li>
            <li><kbd class="px-1 py-0.5 border rounded">Alt</kbd> + <kbd class="px-1 py-0.5 border rounded">‚Üê</kbd> Volver</li>
            <li><kbd class="px-1 py-0.5 border rounded">Alt</kbd> + <kbd class="px-1 py-0.5 border rounded">T</kbd> Tema</li>
            <li><kbd class="px-1 py-0.5 border rounded">R</kbd> Reiniciar</li>
            <li><kbd class="px-1 py-0.5 border rounded">Enter</kbd> Aceptar n√∫mero</li>
          </ul>
        </details>
      </section>

      <!-- Preguntas -->
      <section id="question-section" class="hidden">
        <div class="mb-4">
          <h3 id="question-text" class="text-2xl font-semibold text-gray-800 dark:text-slate-100"></h3>
        </div>
        <form id="options-form" class="space-y-3 mb-6" aria-live="polite"></form>

        <!-- Mensajes -->
        <div id="message-box" class="hidden bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert" aria-atomic="true">
          <span class="block sm:inline" id="message-text"></span>
        </div>

        <!-- Progreso (duplicado para m√≥vil) -->
        <div class="lg:hidden w-full bg-gray-200 rounded-full h-2.5 mb-6">
          <div id="progress-bar-mobile" class="bg-[var(--brand)] h-2.5 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>

        <!-- Navegaci√≥n -->
        <div class="flex justify-between items-center gap-3">
          <button id="back-button" type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-900 font-semibold py-2 px-5 rounded-lg border border-gray-200">
            Volver
          </button>
          <div class="flex items-center gap-3">
            <button id="next-button" type="button" class="bg-[var(--brand)] hover:bg-[var(--brand-600)] text-white font-semibold py-2 px-6 rounded-lg shadow disabled:bg-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed">
              Siguiente
            </button>
          </div>
        </div>
      </section>

      <!-- Resultado -->
      <section id="result-section" class="hidden fade-in">
        <h2 class="text-3xl font-bold text-center mb-5">Tu plan estad√≠stico recomendado</h2>
        <div id="result-content" class="bg-gray-50 dark:bg-slate-800/50 p-6 rounded-xl border border-gray-200 dark:border-slate-700">
          <h3 id="result-title" class="text-2xl font-semibold text-[var(--brand)] mb-3"></h3>

          <div class="space-y-4">
            <div>
              <h4 class="font-semibold text-gray-800 dark:text-slate-100">Descripci√≥n</h4>
              <p id="result-description" class="muted"></p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-800 dark:text-slate-100">Supuestos clave</h4>
              <p id="result-assumptions" class="muted"></p>
            </div>
            <div id="how-to-check-container" class="hidden">
              <h4 class="font-semibold text-gray-800 dark:text-slate-100">C√≥mo comprobar los supuestos</h4>
              <p id="result-how-to-check" class="muted"></p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-800 dark:text-slate-100">Software recomendado</h4>
              <p id="result-software" class="muted"></p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-800 dark:text-slate-100">Recursos</h4>
              <div id="result-resources" class="muted"></div>
            </div>
          </div>
        </div>

        <!-- Acciones -->
        <div class="mt-7 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 no-print">
          <button id="copy-button" class="flex items-center justify-center gap-2 bg-[var(--ok)] hover:bg-emerald-700 text-white font-semibold py-2.5 px-4 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6z"/></svg>
            <span id="copy-button-text">Copiar al portapapeles</span>
          </button>

          <button id="print-button" class="flex items-center justify-center gap-2 bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2.5 px-4 rounded-lg">
            üñ®Ô∏è Imprimir / PDF
          </button>

          <button id="restart-button" class="flex items-center justify-center gap-2 bg-[var(--danger)] hover:bg-red-700 text-white font-semibold py-2.5 px-4 rounded-lg">
            ‚ôªÔ∏è Reiniciar
          </button>

          <button id="export-docx" class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-4 rounded-lg">
            ‚§ì Exportar DOCX
          </button>

          <button id="export-json" class="flex items-center justify-center gap-2 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg">
            ‚§ì Exportar JSON
          </button>

          <label class="flex items-center justify-center gap-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold py-2.5 px-4 rounded-lg cursor-pointer">
            ‚§í Importar JSON
            <input id="import-json" type="file" accept="application/json" class="hidden"/>
          </label>

          <button id="share-link" class="flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2.5 px-4 rounded-lg sm:col-span-2 lg:col-span-3">
            üîó Compartir enlace con mi estado
          </button>
        </div>
      </section>
    </section>
  </main>

  <!-- Footer -->
  <footer class="no-print text-center py-5 px-4 bg-white dark:bg-slate-900 border-t border-gray-200 dark:border-slate-700">
    <p class="text-sm text-gray-600 dark:text-slate-400">
      &copy; <span id="current-year"></span> Aitor Garc√©s Manzanera.
      <a href="https://aitorgarces.github.io/website/estadistica.html" target="_blank" rel="noopener" class="text-[var(--brand)] hover:underline">Web original</a>
    </p>
  </footer>

  <!-- Modal Reinicio -->
  <div id="restart-modal" class="fixed inset-0 bg-gray-900/50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden modal-overlay">
    <div class="relative mx-auto p-5 w-11/12 max-w-md shadow-lg rounded-xl bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700 modal-content">
      <div class="mt-1 text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30">
          <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        </div>
        <h3 class="text-lg font-semibold mt-3">¬øReiniciar asistente?</h3>
        <p class="text-sm text-gray-600 dark:text-slate-400 mt-2">Se borrar√° el progreso actual y volver√°s al inicio.</p>
        <div class="items-center px-4 py-4 flex justify-center gap-3">
          <button id="confirm-restart" class="px-4 py-2 bg-[var(--danger)] text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700">S√≠, reiniciar</button>
          <button id="cancel-restart" class="px-4 py-2 bg-gray-100 dark:bg-slate-800 text-gray-900 dark:text-white text-base font-medium rounded-md shadow-sm border border-gray-200 dark:border-slate-600 hover:bg-gray-200 dark:hover:bg-slate-700">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ayuda -->
  <div id="help-modal" class="fixed inset-0 bg-gray-900/50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden modal-overlay">
    <div class="relative mx-auto p-5 w-11/12 max-w-xl shadow-lg rounded-xl bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700 modal-content">
      <div class="mt-1">
        <h3 class="text-xl font-semibold">Ayuda r√°pida</h3>
        <ul class="mt-3 text-sm text-gray-700 dark:text-slate-300 space-y-2">
          <li><strong>Flujo:</strong> responde a cada paso y avanza con ‚ÄúSiguiente‚Äù.</li>
          <li><strong>Volver:</strong> bot√≥n ‚ÄúVolver‚Äù o Alt+‚Üê.</li>
          <li><strong>Guardar:</strong> se guarda de forma autom√°tica en este navegador.</li>
          <li><strong>Exportar:</strong> DOCX o JSON para compartir o archivar.</li>
          <li><strong>Compartir:</strong> genera un enlace con tu estado actual.</li>
          <li><strong>Accesibilidad:</strong> compatible con teclado y lectores de pantalla.</li>
        </ul>
        <div class="mt-4 text-right">
          <button id="close-help" class="px-4 py-2 bg-[var(--brand)] hover:bg-[var(--brand-600)] text-white rounded-md">Entendido</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Regi√≥n aria-live para toasts -->
  <div id="aria-live" class="sr-only" aria-live="polite"></div>

  <!-- Toasts -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <!-- L√≥gica -->
  <script>
  (function(){
    // ---------- Utilidades UI ----------
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>document.querySelectorAll(sel);

    const dom = {
      startSection: $('#start-section'),
      questionSection: $('#question-section'),
      resultSection: $('#result-section'),
      startButton: $('#start-button'),
      questionText: $('#question-text'),
      optionsForm: $('#options-form'),
      progressBar: $('#progress-bar'),
      progressBarMobile: $('#progress-bar-mobile'),
      backButton: $('#back-button'),
      nextButton: $('#next-button'),
      resultTitle: $('#result-title'),
      resultDescription: $('#result-description'),
      resultAssumptions: $('#result-assumptions'),
      howToCheckContainer: $('#how-to-check-container'),
      resultHowToCheck: $('#result-how-to-check'),
      resultSoftware: $('#result-software'),
      resultResources: $('#result-resources'),
      restartButton: $('#restart-button'),
      copyButton: $('#copy-button'),
      copyButtonText: $('#copy-button-text'),
      printButton: $('#print-button'),
      messageBox: $('#message-box'),
      messageText: $('#message-text'),
      resumeText: $('#resume-text'),
      resumeLink: $('#resume-link'),
      currentYear: $('#current-year'),
      restartModal: $('#restart-modal'),
      confirmRestart: $('#confirm-restart'),
      cancelRestart: $('#cancel-restart'),
      stepper: $('#stepper'),
      jumpLast: $('#jump-last'),
      compactMode: $('#compact-mode'),
      notes: $('#user-notes'),
      themeToggle: $('#theme-toggle'),
      helpButton: $('#help-button'),
      helpModal: $('#help-modal'),
      closeHelp: $('#close-help'),
      saveIndicator: $('#save-indicator'),
      exportDocx: $('#export-docx'),
      exportJson: $('#export-json'),
      importJson: $('#import-json'),
      shareLink: $('#share-link'),
      ariaLive: $('#aria-live'),
      toastContainer: $('#toast-container'),
    };

    // ---------- Estado ----------
    let state = {
      currentQuestionId: null,
      answers: [],          // [{from, answer:{type,value}}]
      userInputs: {},       // map questionId -> value
      totalQuestions: 8,    // estimaci√≥n
      notes: '',
      compact: false
    };

    // ---------- Mensajes/Toasts ----------
    function showMessage(text='', show=false){
      dom.messageText.textContent = text;
      dom.messageBox.classList.toggle('hidden', !show);
      if(show) dom.messageBox.focus?.();
    }

    function toast(msg, variant='ok'){
      const wrap = document.createElement('div');
      wrap.className = 'rounded-lg shadow px-4 py-3 text-sm text-white fade-in';
      wrap.style.background = variant==='ok' ? '#16a34a' : (variant==='warn' ? '#d97706' : '#dc2626');
      wrap.textContent = msg;
      dom.toastContainer.appendChild(wrap);
      dom.ariaLive.textContent = msg;
      setTimeout(()=>wrap.remove(), 3000);
    }

    function markSaved(){
      dom.saveIndicator.classList.remove('hidden');
      setTimeout(()=>dom.saveIndicator.classList.add('hidden'), 1200);
    }

    // ---------- Tema ----------
    function applyTheme(){
      const t = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
      document.documentElement.classList.toggle('dark', t==='dark');
      dom.themeToggle.setAttribute('aria-pressed', t==='dark' ? 'true':'false');
    }
    function toggleTheme(){
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark?'dark':'light');
      dom.themeToggle.setAttribute('aria-pressed', isDark?'true':'false');
      toast(isDark ? 'Tema oscuro activado' : 'Tema claro activado','ok');
    }

    // ---------- Tooltips helper ----------
    const createTooltip = (text) => `
      <span class="tooltip-container align-middle" tabindex="0" aria-label="${text.replace(/"/g,'&quot;')}">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block text-[var(--brand)] ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span class="tooltip-text">${text}</span>
      </span>`;

    // ---------- Datos (preguntas y resultados) ----------
    // (SE MANTIENE tu √°rbol completo; solo reuso createTooltip)
    const questions = {
      q_initial:{id:'q_initial',text:"Antes de seleccionar una prueba, ¬øqu√© deseas hacer?",type:'radio',options:[
        {text:"Explorar y describir mis datos", next:'q_describe_what_var'},
        {text:"Ir directamente a elegir una prueba de hip√≥tesis", next:'q_objective'}
      ]},
      q_describe_what_var:{id:'q_describe_what_var',text:"¬øQu√© tipo de variable principal quieres describir?",type:'radio',options:[
        {text:`Categ√≥rica / Cualitativa ${createTooltip('La variable agrupa en categor√≠as. Ej: G√©nero (Hombre, Mujer), Nivel Educativo (B√°sico, Medio, Superior).')}`, next:'res_describe_categorical'},
        {text:`Num√©rica / Cuantitativa ${createTooltip('La variable es un n√∫mero que se puede medir. Ej: Edad, Puntuaci√≥n en un test, Altura.')}`, next:'res_describe_numerical'}
      ]},
      q_objective:{id:'q_objective',text:"¬øCu√°l es el objetivo principal de tu an√°lisis de hip√≥tesis?",type:'radio',options:[
        {text:"Comparar grupos",next:'q_compare_groups'},
        {text:"Relacionar o asociar variables",next:'q_relate_vars'},
        {text:"Predecir el valor de una variable",next:'q_predict_vars_how_many'},
        {text:"Analizar la fiabilidad de un test/escala",next:'q_reliability'},
        {text:"Explorar la estructura de tus datos (An√°lisis Factorial)",next:'q_factor_analysis'},
      ]},
      q_compare_groups:{id:'q_compare_groups',text:"¬øLas mediciones en los grupos son independientes o relacionadas?",type:'radio',options:[
        {text:`Independientes ${createTooltip('Cada participante pertenece a un √∫nico grupo. Ej: Grupo Control vs. Grupo Tratamiento.')}`, next:'q_n_independent'},
        {text:`Relacionadas / Medidas Repetidas ${createTooltip('Los mismos participantes son medidos en diferentes momentos o condiciones. Ej: Pre-test y Post-test.')}`, next:'q_n_related'},
      ]},
      q_n_independent:{id:'q_n_independent',text:"¬øCu√°ntos grupos independientes (N) quieres comparar?",type:'numberInput',placeholder:"Ej: 3",min:2,
        next:(v)=> v==2?'q_check_assumptions_ttest':'q_check_assumptions_anova'},
      q_n_related:{id:'q_n_related',text:"¬øCu√°ntas mediciones relacionadas (momentos/condiciones) tienes?",type:'numberInput',placeholder:"Ej: 2",min:2,
        next:(v)=> v==2?'q_check_assumptions_ttest_related':'q_check_assumptions_rm_anova'},
      q_check_assumptions_ttest:{id:'q_check_assumptions_ttest',text:`¬øHas comprobado los supuestos para una prueba param√©trica? ${createTooltip('Normalidad (ej. test Shapiro-Wilk) y Homogeneidad de varianzas (ej. test de Levene).')}`,type:'radio',options:[
        {text:"S√≠, y se cumplen",next:'res_t_test_independent'},
        {text:"S√≠, pero NO se cumplen",next:'res_mann_whitney'},
        {text:"No, necesito ayuda para comprobarlos",next:'res_how_to_check_ttest'},
      ]},
      q_check_assumptions_anova:{id:'q_check_assumptions_anova',text:`¬øHas comprobado los supuestos para una prueba param√©trica? ${createTooltip('Normalidad (ej. test Shapiro-Wilk en cada grupo) y Homogeneidad de varianzas (ej. test de Levene).')}`,type:'radio',options:[
        {text:"S√≠, y se cumplen",next:'q_ancova_check'},
        {text:"S√≠, pero NO se cumplen",next:'res_kruskal_wallis'},
        {text:"No, necesito ayuda para comprobarlos",next:'res_how_to_check_anova'},
      ]},
      q_ancova_check:{id:'q_ancova_check',text:`¬øExiste alguna otra variable num√©rica (covariable) que podr√≠a influir en tu variable de resultado y que quisieras controlar? ${createTooltip('Ej: quieres comparar el efecto de dos m√©todos de ense√±anza en las notas, pero quieres controlar por el CI previo de los estudiantes.')}`,type:'radio',options:[
        {text:"S√≠, quiero controlar una covariable",next:'res_ancova'},
        {text:"No, solo quiero comparar los grupos",next:'res_anova_oneway'},
      ]},
      q_check_assumptions_ttest_related:{id:'q_check_assumptions_ttest_related',text:`¬øHas comprobado si las diferencias entre las mediciones siguen una distribuci√≥n normal? ${createTooltip('Calcula la diferencia (Post - Pre) y realiza un test de normalidad (ej. Shapiro-Wilk) sobre esas diferencias.')}`,type:'radio',options:[
        {text:"S√≠, las diferencias son normales",next:'res_t_test_related'},
        {text:"No, las diferencias no son normales",next:'res_wilcoxon'},
        {text:"No, necesito ayuda para comprobarlo",next:'res_how_to_check_ttest_related'},
      ]},
      q_check_assumptions_rm_anova:{id:'q_check_assumptions_rm_anova',text:`¬øHas comprobado los supuestos de normalidad y esfericidad? ${createTooltip('La esfericidad (Test de Mauchly) es clave. Si p > .05, se cumple. Si no, correcciones.')}`,type:'radio',options:[
        {text:"S√≠, y se cumplen",next:'res_rm_anova'},
        {text:"S√≠, pero NO se cumplen",next:'res_friedman'},
        {text:"No, necesito ayuda para comprobarlos",next:'res_how_to_check_rm_anova'},
      ]},
      q_relate_vars:{id:'q_relate_vars',text:"¬øQu√© tipo de variables quieres relacionar?",type:'radio',options:[
        {text:"Dos variables num√©ricas/cuantitativas",next:'q_relate_continuous'},
        {text:"Dos variables ordinales (o num√©ricas no param√©tricas)",next:'q_relate_ordinal'},
        {text:"Dos variables categ√≥ricas/nominales",next:'res_chi_square'},
      ]},
      q_relate_continuous:{id:'q_relate_continuous',text:`¬øLa relaci√≥n es lineal y los datos son param√©tricos? ${createTooltip('Un diagrama de dispersi√≥n ayuda con la linealidad. Comprueba normalidad con Shapiro-Wilk.')}`,type:'radio',options:[
        {text:"S√≠",next:'q_partial_corr_check'},
        {text:"No",next:'q_partial_corr_check_spearman'},
      ]},
      q_relate_ordinal:{id:'q_relate_ordinal',text:`Vas a usar una correlaci√≥n de Spearman. ¬øQuieres controlar una tercera variable? ${createTooltip('A√≠sla la relaci√≥n principal eliminando un confusor.')}`,type:'radio',options:[
        {text:"S√≠, quiero controlar una tercera variable",next:'res_partial_spearman'},
        {text:"No, solo la relaci√≥n entre las dos",next:'res_spearman'},
      ]},
      q_partial_corr_check:{id:'q_partial_corr_check',text:`Vas a usar Pearson. ¬øControlar una tercera variable? ${createTooltip('Elimina la influencia de una variable confusora.')}`,type:'radio',options:[
        {text:"S√≠, controlar una tercera variable",next:'res_partial_pearson'},
        {text:"No, solo la relaci√≥n entre las dos",next:'res_pearson'},
      ]},
      q_partial_corr_check_spearman:{id:'q_partial_corr_check_spearman',text:`Vas a usar Spearman. ¬øControlar una tercera variable? ${createTooltip('Versi√≥n no param√©trica.')}`,type:'radio',options:[
        {text:"S√≠, controlar una tercera variable",next:'res_partial_spearman'},
        {text:"No, solo la relaci√≥n entre las dos",next:'res_spearman'},
      ]},
      q_predict_vars_how_many:{id:'q_predict_vars_how_many',text:"¬øCu√°ntas variables predictoras (independientes) usar√°s?",type:'radio',options:[
        {text:`Una sola variable predictora ${createTooltip('Ej: predecir nota con horas de estudio.')}`, next:'q_predict_var_type'},
        {text:`Dos o m√°s variables predictoras ${createTooltip('Ej: horas de estudio, CI y motivaci√≥n.')}`, next:'q_predict_var_type_multiple'},
      ]},
      q_predict_var_type:{id:'q_predict_var_type',text:"¬øQu√© tipo de variable quieres predecir (dependiente)?",type:'radio',options:[
        {text:"Una variable continua (Regresi√≥n Lineal Simple)",next:'res_linear_regression_simple'},
        {text:"Una variable categ√≥rica (Regresi√≥n Log√≠stica Simple)",next:'res_logistic_regression_simple'},
      ]},
      q_predict_var_type_multiple:{id:'q_predict_var_type_multiple',text:"¬øQu√© tipo de variable quieres predecir (dependiente)?",type:'radio',options:[
        {text:"Una variable continua (Regresi√≥n Lineal M√∫ltiple)",next:'res_linear_regression_multiple'},
        {text:"Una variable categ√≥rica (Regresi√≥n Log√≠stica M√∫ltiple)",next:'res_logistic_regression_multiple'},
      ]},
      q_reliability:{id:'q_reliability',text:"¬øQu√© tipo de fiabilidad quieres medir?",type:'radio',options:[
        {text:`Consistencia interna de una escala ${createTooltip('Para √≠tems tipo Likert.')}`, next:'res_cronbach_alpha'},
        {text:`Concordancia entre dos observadores/jueces ${createTooltip('Acuerdo categ√≥rico entre evaluadores.')}`, next:'res_cohen_kappa'},
      ]},
      q_factor_analysis:{id:'q_factor_analysis',text:"¬øTu an√°lisis factorial es exploratorio o confirmatorio?",type:'radio',options:[
        {text:`Exploratorio (AFE) ${createTooltip('Explora estructura sin hip√≥tesis previa.')}`, next:'res_efa'},
        {text:`Confirmatorio (AFC) ${createTooltip('Contrasta un modelo te√≥rico con SEM.')}`, next:'res_cfa'},
      ]},
    };

    const results = {
      res_describe_categorical:{title:"An√°lisis Descriptivo para Variable Categ√≥rica",description:"Para entender la distribuci√≥n de una variable que agrupa en categor√≠as, c√©ntrate en las frecuencias.",assumptions:"No se requieren supuestos. Este paso es exploratorio.",howToCheck:"",software:"SPSS, R, Python, Excel, JASP, Jamovi.",resources:"<ul><li><b>Tabla de frecuencias</b> (N y %)</li><li><b>Gr√°fico de barras</b></li><li><b>Gr√°fico circular</b> si hay pocas categor√≠as</li></ul>"},
      res_describe_numerical:{title:"An√°lisis Descriptivo para Variable Num√©rica",description:"Examina tendencia central, dispersi√≥n y forma de la distribuci√≥n.",assumptions:"No hay supuestos para describir; √∫til para pasos posteriores.",howToCheck:"",software:"SPSS, R, Python, JASP, Jamovi.",resources:"<ul><li><b>Media</b> y <b>mediana</b></li><li><b>Desviaci√≥n est√°ndar</b> y rango</li><li><b>Histograma</b> y <b>Box Plot</b></li></ul>"},
      res_how_to_check_ttest:{title:"Comprobaci√≥n de supuestos (t indep.)",description:"Comprueba normalidad y homogeneidad de varianzas.",assumptions:"Ideal si p > .05 en ambas pruebas.",howToCheck:"<b>1. Normalidad:</b> Shapiro‚ÄìWilk por grupo (p > .05).<br><b>2. Homogeneidad:</b> Levene (p > .05).<br><br><b>Decisi√≥n:</b> si fallan, usa U de Mann‚ÄìWhitney.",software:"SPSS, R, Python, JASP, Jamovi.",resources:""},
      res_how_to_check_anova:{title:"Comprobaci√≥n de supuestos (ANOVA)",description:"Similar a t pero para ‚â•3 grupos.",assumptions:"Ideal si p > .05 en ambas pruebas.",howToCheck:"<b>1. Normalidad:</b> Shapiro‚ÄìWilk en cada grupo (p > .05).<br><b>2. Homogeneidad:</b> Levene (p > .05).<br><br><b>Decisi√≥n:</b> si fallan, Kruskal‚ÄìWallis.",software:"SPSS, R, Python, JASP, Jamovi.",resources:""},
      res_how_to_check_ttest_related:{title:"Comprobaci√≥n de supuestos (t pareada)",description:"La normalidad se aplica a las diferencias.",assumptions:"Ideal si p > .05.",howToCheck:"1) Calcula Post‚ÄìPre. 2) Shapiro‚ÄìWilk sobre la diferencia. 3) Si falla, usa Wilcoxon.",software:"SPSS, R, Python, JASP, Jamovi.",resources:""},
      res_how_to_check_rm_anova:{title:"Comprobaci√≥n de supuestos (ANOVA rep.)",description:"Adem√°s de normalidad, revisa esfericidad.",assumptions:"Normalidad y esfericidad (p > .05).",howToCheck:"<b>Mauchly</b> para esfericidad. Si falla, corrige con Greenhouse‚ÄìGeisser o Huynh‚ÄìFeldt.",software:"SPSS, R, JASP, Jamovi.",resources:""},
      res_t_test_independent:{title:"Prueba t para muestras independientes",description:"Compara medias de dos grupos independientes.",assumptions:"VD continua, independencia, normalidad por grupo, varianzas iguales.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.cienciadedatos.net/documentos/pystad_t-test.html">Gu√≠a r√°pida</a>'},
      res_mann_whitney:{title:"U de Mann‚ÄìWhitney",description:"Alternativa no param√©trica a t independiente.",assumptions:"VD ordinal o continua; independencia; formas similares.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://humanidades.com/prueba-u-de-mann-whitney/">Referencia</a>'},
      res_anova_oneway:{title:"ANOVA de un factor",description:"Compara medias de ‚â•3 grupos independientes. Si hay diferencias, usa post-hoc.",assumptions:"Normalidad, homogeneidad de varianzas, independencia.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.questionpro.com/blog/es/anova-de-un-factor/">Referencia</a>'},
      res_ancova:{title:"ANCOVA",description:"ANOVA controlando una covariable continua.",assumptions:"Supuestos de ANOVA + independencia VI‚Äìcovariable y relaci√≥n lineal covariable‚ÄìVD.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.datanovia.com/en/lessons/ancova-in-r/">C√≥mo en R</a>'},
      res_kruskal_wallis:{title:"Kruskal‚ÄìWallis",description:"Alternativa no param√©trica al ANOVA de un factor.",assumptions:"VD ordinal/continua; independencia; formas similares.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.addlink.es/noticias/minitab/2833-cuando-utilizar-la-prueba-de-kruskal-wallis">Referencia</a>'},
      res_t_test_related:{title:"t para muestras relacionadas",description:"Compara medias de dos medidas en los mismos sujetos.",assumptions:"Normalidad de las diferencias.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://proyectodescartes.org/inferencia/materiales_didacticos/estim_contraste_param-JS/t_muestras_pareadas.html">Referencia</a>'},
      res_wilcoxon:{title:"Wilcoxon (rangos con signo)",description:"Alternativa no param√©trica a t pareada.",assumptions:"Diferencias con simetr√≠a aproximada.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.cienciadedatos.net/documentos/pystad_wilcoxon_rank_sum_test.html">Referencia</a>'},
      res_rm_anova:{title:"ANOVA de medidas repetidas",description:"Compara medias de ‚â•3 medidas en los mismos sujetos.",assumptions:"Normalidad y esfericidad (si falla, correcciones).",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://investigaliacr.com/investigacion/anova-para-medidas-repetidas-de-un-factor/">Referencia</a>'},
      res_friedman:{title:"Friedman",description:"Alternativa no param√©trica al ANOVA repetido.",assumptions:"Sin necesidad de normalidad ni esfericidad.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.questionpro.com/blog/es/prueba-de-friedman/">Referencia</a>'},
      res_pearson:{title:"Correlaci√≥n de Pearson (r)",description:"Asociaci√≥n lineal entre dos variables continuas.",assumptions:"Continuas; linealidad; normalidad bivariada.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.questionpro.com/blog/es/coeficiente-de-correlacion-de-pearson/">Referencia</a>'},
      res_partial_pearson:{title:"Correlaci√≥n parcial (Pearson)",description:"Relaci√≥n lineal entre dos variables controlando otra(s).",assumptions:"Como Pearson, aplicado a residuos.",software:"SPSS, R, Python.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.statology.org/partial-correlation-in-r/">Referencia</a>'},
      res_spearman:{title:"Correlaci√≥n de Spearman (œÅ)",description:"Asociaci√≥n monot√≥nica con rangos.",assumptions:"Al menos ordinales; sin normalidad.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.addlink.es/noticias/minitab/2821-correlacion-de-spearman-la-guia-sencilla">Referencia</a>'},
      res_partial_spearman:{title:"Correlaci√≥n parcial (Spearman)",description:"Relaci√≥n monot√≥nica controlando otra(s).",assumptions:"Variables ordinales/continuas sin normalidad.",software:"R (ppcor), Python (pingouin).",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.statology.org/partial-correlation-python/">Referencia</a>'},
      res_chi_square:{title:"Chi-cuadrado de independencia",description:"Asociaci√≥n entre dos variables categ√≥ricas.",assumptions:"Frecuencias esperadas > 5; si no, Fisher.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.jmp.com/es_es/statistics-knowledge-portal/chi-square-test.html">Referencia</a>'},
      res_linear_regression_simple:{title:"Regresi√≥n lineal simple",description:"Y = b0 + b1¬∑X para predecir VD continua con un predictor.",assumptions:"Linealidad; independencia; homocedasticidad; normalidad de errores.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.ibm.com/es-es/analytics/learn/linear-regression">Referencia</a>'},
      res_linear_regression_multiple:{title:"Regresi√≥n lineal m√∫ltiple",description:"VD continua con varios predictores.",assumptions:"Las de la simple + sin multicolinealidad.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.cienciadedatos.net/documentos/py10-regresion-lineal-multiple-python.html">Referencia</a>'},
      res_logistic_regression_simple:{title:"Regresi√≥n log√≠stica simple",description:"Probabilidad de evento con un predictor.",assumptions:"VD categ√≥rica; independencia; relaci√≥n lineal predictor‚Äìlogit.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.cienciadedatos.net/documentos/py17-regresion-logistica-python.html">Referencia</a>'},
      res_logistic_regression_multiple:{title:"Regresi√≥n log√≠stica m√∫ltiple",description:"Probabilidad de evento con varios predictores.",assumptions:"Como la simple + sin multicolinealidad.",software:"SPSS, R, Python, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.datanovia.com/en/lessons/multiple-logistic-regression-in-r/">Referencia</a>'},
      res_cronbach_alpha:{title:"Alfa de Cronbach (Œ±)",description:"Consistencia interna de una escala.",assumptions:"Unidimensionalidad; nivel al menos de intervalo.",software:"SPSS, R, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.questionpro.com/blog/es/alfa-de-cronbach/">Referencia</a>'},
      res_cohen_kappa:{title:"Kappa de Cohen (Œ∫)",description:"Acuerdo entre evaluadores corrigiendo azar.",assumptions:"Datos categ√≥ricos; evaluadores independientes.",software:"SPSS, R, JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://universidadeuropea.com/blog/coeficiente-kappa-cohen/">Referencia</a>'},
      res_efa:{title:"An√°lisis factorial exploratorio (AFE)",description:"Identifica estructura latente sin modelo previo.",assumptions:"Datos continuos/ordinales; relaciones lineales; tama√±o muestral adecuado.",software:"SPSS, R (psych), JASP, Jamovi.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://explorable.com/es/analisis-factorial-exploratorio">Referencia</a>'},
      res_cfa:{title:"An√°lisis factorial confirmatorio (AFC)",description:"Contrasta un modelo de factores con SEM.",assumptions:"Modelo te√≥rico; muestra grande; normalidad multivariante (o estimadores robustos).",software:"R (lavaan), AMOS, Mplus, JASP.",resources:'<a class="text-[var(--brand)] hover:underline" target="_blank" href="https://www.psicologia-online.com/analisis-factorial-confirmatorio-que-es-y-como-se-realiza-5437.html">Referencia</a>'},
    };

    // ---------- Persistencia ----------
    function saveState(){
      try{
        state.notes = dom.notes.value || '';
        localStorage.setItem('statsPlannerState', JSON.stringify(state));
        markSaved();
      }catch(e){ console.error('No se pudo guardar el estado:', e); }
    }
    function loadState(){
      try{
        const saved = localStorage.getItem('statsPlannerState');
        if(saved){
          state = JSON.parse(saved);
          if(state.currentQuestionId && !String(state.currentQuestionId).startsWith('res_')){
            dom.resumeText.classList.remove('hidden');
            dom.resumeLink.classList.remove('hidden');
          }
          dom.notes.value = state.notes || '';
          dom.compactMode.checked = !!state.compact;
          applyCompactMode(!!state.compact);
        }
      }catch(e){
        console.error('No se pudo cargar el estado:', e);
        localStorage.removeItem('statsPlannerState');
      }
    }

    // Compartir por enlace (hash base64 url-safe)
    function encodeStateToUrl(){
      const raw = JSON.stringify(state);
      const b64 = btoa(unescape(encodeURIComponent(raw))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      const url = location.origin + location.pathname + '#s=' + b64;
      navigator.clipboard.writeText(url).then(()=>toast('Enlace copiado','ok')).catch(()=>toast('No se pudo copiar','err'));
    }
    function tryRestoreFromUrl(){
      if(location.hash.startsWith('#s=')){
        try{
          const b64 = location.hash.slice(3).replace(/-/g,'+').replace(/_/g,'/');
          const raw = decodeURIComponent(escape(atob(b64)));
          const parsed = JSON.parse(raw);
          if(parsed && parsed.currentQuestionId){
            state = parsed;
            dom.notes.value = state.notes || '';
            dom.compactMode.checked = !!state.compact;
            applyCompactMode(!!state.compact);
            startQuiz(true);
            toast('Estado cargado desde enlace','ok');
          }
        }catch(e){ console.warn('Hash inv√°lido'); }
      }
    }

    // ---------- UI helpers ----------
    function updateProgressBars(){
      const pct = Math.min((state.answers.length / state.totalQuestions) * 100, 100);
      dom.progressBar.style.width = pct + '%';
      if(dom.progressBarMobile) dom.progressBarMobile.style.width = pct + '%';
    }

    function rebuildStepper(){
      dom.stepper.innerHTML = '';
      state.answers.forEach((step, idx)=>{
        const li = document.createElement('li');
        li.className = 'flex items-start gap-2';
        li.innerHTML = `
          <span class="mt-1 h-2 w-2 rounded-full ${idx===state.answers.length-1?'bg-[var(--brand)]':'bg-gray-300 dark:bg-slate-600'}"></span>
          <button class="text-left flex-1 text-gray-700 dark:text-slate-300 hover:underline" data-step="${idx}">
            ${step.from.replace(/^q_/,'').replaceAll('_',' ')}
          </button>
        `;
        dom.stepper.appendChild(li);
      });
      // Click to jump
      dom.stepper.querySelectorAll('button[data-step]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const idx = parseInt(e.currentTarget.getAttribute('data-step'),10);
          jumpToStep(idx);
        });
      });
    }

    function applyCompactMode(on){
      document.body.classList.toggle('text-[15px]', on);
      document.querySelectorAll('.card').forEach(c=>{
        c.classList.toggle('p-4', on);
        c.classList.toggle('p-6', !on);
      });
      state.compact = !!on;
      saveState();
    }

    // ---------- Render ----------
    function showQuestion(questionId){
      const qData = questions[questionId];
      if(!qData) return;

      state.currentQuestionId = questionId;
      dom.questionText.innerHTML = qData.text;
      dom.optionsForm.innerHTML = '';
      showMessage('', false);

      if(qData.type==='radio'){
        qData.options.forEach((option, index)=>{
          const optId = `opt_${questionId}_${index}`;
          const div = document.createElement('div');
          div.className = 'block';
          div.innerHTML = `
            <label for="${optId}" class="flex items-start gap-3 p-3 border border-gray-200 dark:border-slate-700 rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-slate-800/50 transition-colors">
              <input type="radio" id="${optId}" name="option" value="${option.next}" class="mt-0.5 h-4 w-4 text-[var(--brand)] border-gray-300 focus:ring-[var(--brand)]">
              <span class="text-gray-800 dark:text-slate-100">${option.text}</span>
            </label>`;
          dom.optionsForm.appendChild(div);
        });
      }else if(qData.type==='numberInput'){
        const inputId = `input_${questionId}`;
        const div = document.createElement('div');
        div.innerHTML = `
          <label for="${inputId}" class="sr-only">${qData.text}</label>
          <input type="number" id="${inputId}" min="${qData.min}" placeholder="${qData.placeholder}"
            class="w-full px-4 py-3 text-lg text-center border border-gray-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-[var(--brand)] focus:border-[var(--brand)] bg-white dark:bg-slate-900 dark:text-slate-100 transition">
          <p class="text-xs text-gray-500 mt-2">Introduce un entero ‚â• ${qData.min}</p>
        `;
        dom.optionsForm.appendChild(div);
        const inp = document.getElementById(inputId);
        inp.value = state.userInputs[qData.id] ?? '';
        inp.focus();
      }

      dom.backButton.classList.toggle('hidden', state.answers.length===0);
      updateProgressBars();
      rebuildStepper();
      validateNextAvailability();
      saveState();
    }

    function showResult(resultId){
      const resultData = results[resultId];
      if(!resultData) return;
      state.currentQuestionId = resultId;

      let title = resultData.title;
      if(resultId==='res_anova_oneway' && state.userInputs.q_n_independent){
        title += ` (para ${state.userInputs.q_n_independent} grupos)`;
      }else if(resultId==='res_rm_anova' && state.userInputs.q_n_related){
        title += ` (para ${state.userInputs.q_n_related} mediciones)`;
      }

      dom.resultTitle.textContent = title;
      dom.resultDescription.innerHTML = resultData.description;
      dom.resultAssumptions.innerHTML = resultData.assumptions || '‚Äî';
      dom.resultSoftware.innerHTML = resultData.software || '‚Äî';
      dom.resultResources.innerHTML = resultData.resources || '';
      if(resultData.howToCheck){
        dom.resultHowToCheck.innerHTML = resultData.howToCheck;
        dom.howToCheckContainer.classList.remove('hidden');
      }else{
        dom.howToCheckContainer.classList.add('hidden');
      }

      dom.questionSection.classList.add('hidden');
      dom.resultSection.classList.remove('hidden');
      dom.resultSection.classList.add('fade-in');

      updateProgressBars();
      rebuildStepper();
      saveState();
      toast('Plan generado','ok');
    }

    function validateNextAvailability(){
      const qData = questions[state.currentQuestionId];
      if(!qData){ dom.nextButton.disabled = false; return; }
      if(qData.type==='radio'){
        const anyChecked = !!dom.optionsForm.querySelector('input[name="option"]:checked');
        dom.nextButton.disabled = !anyChecked;
      }else if(qData.type==='numberInput'){
        const inputElem = dom.optionsForm.querySelector('input[type="number"]');
        const value = parseInt(inputElem?.value ?? '', 10);
        dom.nextButton.disabled = !(Number.isInteger(value) && value >= qData.min);
      }
    }

    // ---------- Navegaci√≥n ----------
    function handleNext(){
      const qData = questions[state.currentQuestionId];
      if(!qData) return;

      let nextQuestionId = null;
      let userAnswer = null;

      if(qData.type==='radio'){
        const selectedOption = dom.optionsForm.querySelector('input[name="option"]:checked');
        if(!selectedOption){ showMessage('Selecciona una opci√≥n para continuar.', true); return; }
        nextQuestionId = selectedOption.value;
        userAnswer = {type:'radio', value:selectedOption.id};
      }else if(qData.type==='numberInput'){
        const inputElem = dom.optionsForm.querySelector('input[type="number"]');
        const value = parseInt(inputElem.value, 10);
        if(isNaN(value) || value < qData.min){
          showMessage(`Introduce un n√∫mero v√°lido (m√≠nimo ${qData.min}).`, true);
          return;
        }
        nextQuestionId = qData.next(value);
        userAnswer = {type:'numberInput', value:value};
        state.userInputs[qData.id] = value;
      }

      if(!nextQuestionId) return;
      state.answers.push({from: state.currentQuestionId, answer: userAnswer});

      if(nextQuestionId.startsWith('res_')) showResult(nextQuestionId);
      else showQuestion(nextQuestionId);
    }

    function handleBack(){
      if(state.answers.length===0) return;
      const last = state.answers.pop();
      const prevQ = last.from;
      if(state.userInputs[prevQ]) delete state.userInputs[prevQ];
      dom.resultSection.classList.add('hidden');
      dom.questionSection.classList.remove('hidden');
      showQuestion(prevQ);

      const qData = questions[prevQ];
      if(last.answer.type==='radio'){
        const radioToSelect = document.getElementById(last.answer.value);
        if(radioToSelect){ radioToSelect.checked = true; }
      }else if(qData.type==='numberInput'){
        const inp = dom.optionsForm.querySelector('input[type="number"]');
        if(inp){ inp.value = last.answer.value; }
      }
    }

    function jumpToStep(idx){
      if(idx<0 || idx>=state.answers.length) return;
      const target = state.answers[idx];
      // recorta historial
      state.answers = state.answers.slice(0, idx);
      dom.resultSection.classList.add('hidden');
      dom.questionSection.classList.remove('hidden');
      showQuestion(target.from);
    }

    function startQuiz(resume=false){
      dom.startSection.classList.add('hidden');
      dom.resultSection.classList.add('hidden');
      dom.questionSection.classList.remove('hidden');
      dom.questionSection.classList.add('fade-in');
      if(!resume){
        state.currentQuestionId = 'q_initial';
        state.answers = [];
        state.userInputs = {};
      }
      showQuestion(state.currentQuestionId);
      toast(resume?'Continuando donde lo dejaste':'Empezamos','ok');
    }

    function openRestartModal(){ dom.restartModal.classList.remove('hidden'); }
    function closeRestartModal(){ dom.restartModal.classList.add('hidden'); }
    function resetApp(){
      state = { currentQuestionId:null, answers:[], userInputs:{}, totalQuestions:8, notes:'', compact: !!dom.compactMode.checked };
      localStorage.removeItem('statsPlannerState');
      dom.resultSection.classList.add('hidden');
      dom.questionSection.classList.add('hidden');
      dom.startSection.classList.remove('hidden');
      dom.startSection.classList.add('fade-in');
      dom.resumeText.classList.add('hidden');
      dom.resumeLink.classList.add('hidden');
      dom.notes.value = '';
      closeRestartModal();
      rebuildStepper();
      updateProgressBars();
      toast('Reiniciado','warn');
    }

    function copyResult(){
      const title = dom.resultTitle.textContent.trim();
      const description = `Descripci√≥n: ${dom.resultDescription.textContent.trim()}`;
      const assumptions = `Supuestos clave: ${dom.resultAssumptions.textContent.trim()}`;
      let howToCheck = '';
      if(!dom.howToCheckContainer.classList.contains('hidden')){
        howToCheck = `C√≥mo comprobar: ${dom.resultHowToCheck.textContent.trim()}`;
      }
      const software = `Software: ${dom.resultSoftware.textContent.trim()}`;
      const resources = `Recursos: ${dom.resultResources.textContent.trim()}`;

      const textToCopy = [title, description, assumptions, howToCheck, software, resources].filter(Boolean).join('\n\n');

      navigator.clipboard.writeText(textToCopy).then(()=>{
        dom.copyButtonText.textContent = '¬°Copiado!';
        setTimeout(()=> dom.copyButtonText.textContent = 'Copiar al portapapeles', 1600);
        toast('Copiado al portapapeles','ok');
      }).catch(()=>{
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = textToCopy;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand('copy'); toast('Copiado','ok'); }catch(e){ toast('No se pudo copiar','err'); }
        document.body.removeChild(ta);
      });
    }

    // ---------- Exportar DOCX ----------
    async function exportDocx(){
      const { Document, Packer, Paragraph, TextRun, HeadingLevel } = window.docx;
      const paras = [];
      const pushH = (t)=>paras.push(new Paragraph({text:t, heading:HeadingLevel.HEADING_1}));
      const pushH2 = (t)=>paras.push(new Paragraph({text:t, heading:HeadingLevel.HEADING_2}));
      const pushP = (t)=>paras.push(new Paragraph({children:[new TextRun({text:t})]}));

      pushH('Plan estad√≠stico recomendado');
      pushH2(dom.resultTitle.textContent.trim() || '‚Äî');

      pushH2('Descripci√≥n');
      pushP(dom.resultDescription.textContent.trim() || '‚Äî');

      pushH2('Supuestos clave');
      pushP(dom.resultAssumptions.textContent.trim() || '‚Äî');

      if(!dom.howToCheckContainer.classList.contains('hidden')){
        pushH2('C√≥mo comprobar los supuestos');
        pushP(dom.resultHowToCheck.textContent.trim() || '‚Äî');
      }

      pushH2('Software recomendado');
      pushP(dom.resultSoftware.textContent.trim() || '‚Äî');

      pushH2('Recursos');
      pushP(dom.resultResources.textContent.trim() || '‚Äî');

      if(state.answers?.length){
        pushH2('Ruta de decisiones');
        state.answers.forEach((a,i)=>pushP(`${i+1}. ${a.from}`));
      }

      if(state.notes){
        pushH2('Notas del proyecto');
        pushP(state.notes);
      }

      const doc = new Document({sections:[{children:paras}]});
      const blob = await Packer.toBlob(doc);
      const fname = 'plan_estadistico.docx';
      if(window.saveAs){ window.saveAs(blob, fname); }
      else{
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = fname; a.click();
        URL.revokeObjectURL(url);
      }
      toast('DOCX generado','ok');
    }

    // ---------- Export/Import JSON ----------
    function exportJSON(){
      const data = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(data);
      const a = document.createElement('a');
      a.href = url; a.download = 'asistente_estadistica_estado.json'; a.click();
      URL.revokeObjectURL(url);
      toast('JSON exportado','ok');
    }
    function importJSONFile(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const obj = JSON.parse(e.target.result);
          if(!obj || !obj.currentQuestionId) throw new Error('Estructura inv√°lida');
          state = obj;
          dom.notes.value = state.notes || '';
          dom.compactMode.checked = !!state.compact;
          applyCompactMode(!!state.compact);
          saveState();
          if(String(state.currentQuestionId).startsWith('res_')){ // ir directo al resultado
            dom.startSection.classList.add('hidden');
            showResult(state.currentQuestionId);
          }else{
            startQuiz(true);
          }
          toast('Estado importado','ok');
        }catch(err){
          console.error(err);
          toast('Archivo no v√°lido','err');
        }
      };
      reader.readAsText(file);
    }

    // ---------- Eventos ----------
    dom.startButton.addEventListener('click', ()=>startQuiz(false));
    dom.resumeLink.addEventListener('click', (e)=>{ e.preventDefault(); startQuiz(true); });
    dom.nextButton.addEventListener('click', handleNext);
    dom.backButton.addEventListener('click', handleBack);
    dom.restartButton.addEventListener('click', openRestartModal);
    dom.confirmRestart.addEventListener('click', resetApp);
    dom.cancelRestart.addEventListener('click', closeRestartModal);
    dom.copyButton.addEventListener('click', copyResult);
    dom.printButton.addEventListener('click', ()=>window.print());
    dom.jumpLast.addEventListener('click', ()=> jumpToStep(state.answers.length-1));
    dom.themeToggle.addEventListener('click', toggleTheme);
    dom.helpButton.addEventListener('click', ()=> dom.helpModal.classList.remove('hidden'));
    dom.closeHelp.addEventListener('click', ()=> dom.helpModal.classList.add('hidden'));
    dom.exportDocx.addEventListener('click', exportDocx);
    dom.exportJson.addEventListener('click', exportJSON);
    dom.importJson.addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f) importJSONFile(f); e.target.value=''; });
    dom.shareLink.addEventListener('click', encodeStateToUrl);

    // Validaci√≥n din√°mica
    dom.optionsForm.addEventListener('change', validateNextAvailability);
    dom.optionsForm.addEventListener('input', validateNextAvailability);

    // Enter en numberInput
    dom.questionSection.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        const qData = questions[state.currentQuestionId];
        if(qData?.type==='numberInput'){ e.preventDefault(); handleNext(); }
      }
    });

    // Atajos de teclado globales
    document.addEventListener('keydown', (e)=>{
      if(e.altKey && e.key==='ArrowRight'){ e.preventDefault(); if(!dom.resultSection.classList.contains('hidden')) return; handleNext(); }
      if(e.altKey && e.key==='ArrowLeft'){ e.preventDefault(); handleBack(); }
      if(e.altKey && (e.key==='t' || e.key==='T')){ e.preventDefault(); toggleTheme(); }
      if(e.key==='r' || e.key==='R'){ openRestartModal(); }
      if(e.altKey && (e.key==='h' || e.key==='H')){ e.preventDefault(); dom.helpModal.classList.remove('hidden'); }
    });

    // Guardado en cambios de notas y modo compacto
    dom.notes.addEventListener('input', ()=> { saveState(); });
    dom.compactMode.addEventListener('change', (e)=> applyCompactMode(e.target.checked));

    // ---------- Inicializaci√≥n ----------
    dom.currentYear.textContent = new Date().getFullYear();
    applyTheme();
    loadState();
    tryRestoreFromUrl();

    // Si hay un currentQuestionId result -> mostrar acorde al estado
    if(state.currentQuestionId){
      if(String(state.currentQuestionId).startsWith('res_')) showResult(state.currentQuestionId);
      else{
        dom.startSection.classList.add('hidden');
        dom.questionSection.classList.remove('hidden');
        showQuestion(state.currentQuestionId);
      }
    }

    // Observador de guardado autom√°tico
    window.addEventListener('beforeunload', saveState);
  })();
  </script>

  <!-- Contador externo (se mantiene) -->
  <div class="mt-4 text-center text-xs opacity-60 no-print">
    <div class="inline-block scale-75">
      <script type="text/javascript" src="https://contador.websiteout.com/js/5/5/1/0"></script>
    </div>
  </div>
</body>
</html>

